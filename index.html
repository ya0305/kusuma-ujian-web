<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Ujian Online</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/supabase.min.js"></script>
// 1. SETUP SUPABASE - PASTIKAN INI BENAR
const supabaseUrl = 'https://YOUR_PROJECT.supabase.co'  // Ganti dengan URL Anda
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // Ganti dengan key Anda
const { createClient } = supabase  // Pastikan ini ada
const supabaseClient = createClient(supabaseUrl, supabaseAnonKey)

// 2. DEBUGGING VARIABLES
let timerSubscription = null
let currentSessionId = 'global-timer'  // Fixed ID untuk semua user
let isAdmin = false
let debugMode = true  // Set true untuk lihat log

// 3. DEBUG FUNCTION
function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`[TIMER DEBUG] ${message}`, data)
        // Tampilkan di halaman juga
        const debugEl = document.getElementById('debug-info')
        if (debugEl) {
            debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`
            debugEl.scrollTop = debugEl.scrollHeight
        }
    }
}

// 4. TEST KONEKSI SUPABASE
async function testSupabaseConnection() {
    debugLog('Testing Supabase connection...')
    try {
        const { data, error } = await supabaseClient
            .from('timer_sessions')
            .select('count(*)')
            .limit(1)
        
        if (error) {
            debugLog('Supabase connection ERROR:', error)
            return false
        } else {
            debugLog('Supabase connection SUCCESS')
            return true
        }
    } catch (err) {
        debugLog('Supabase connection FAILED:', err)
        return false
    }
}

// 5. SYNC TIMER KE SUPABASE (ADMIN ONLY)
async function syncTimerToSupabase(timerData) {
    if (!isAdmin) {
        debugLog('Not admin, skipping sync')
        return
    }
    
    debugLog('Syncing timer to Supabase:', timerData)
    
    try {
        const payload = {
            id: currentSessionId,
            session_name: 'Global Timer',
            duration: timerData.totalTime || 0,
            remaining_time: timerData.remainingTime || 0,
            is_active: timerData.isRunning || false,
            started_at: timerData.isRunning ? new Date().toISOString() : null,
            updated_at: new Date().toISOString()
        }
        
        debugLog('Payload to sync:', payload)
        
        const { data, error } = await supabaseClient
            .from('timer_sessions')
            .upsert(payload)
            .select()
        
        if (error) {
            debugLog('Sync ERROR:', error)
        } else {
            debugLog('Sync SUCCESS:', data)
        }
    } catch (err) {
        debugLog('Sync EXCEPTION:', err)
    }
}

// 6. SUBSCRIBE KE REAL-TIME UPDATES
function subscribeToTimer() {
    debugLog('Setting up real-time subscription...')
    
    // Unsubscribe existing
    if (timerSubscription) {
        timerSubscription.unsubscribe()
    }
    
    timerSubscription = supabaseClient
        .channel('timer-channel')
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'timer_sessions',
            filter: `id=eq.${currentSessionId}`
        }, (payload) => {
            debugLog('Real-time update received:', payload)
            
            if (payload.new) {
                handleTimerUpdate(payload.new)
            }
        })
        .subscribe((status) => {
            debugLog('Subscription status:', status)
            updateConnectionStatus(status === 'SUBSCRIBED')
        })
}

// 7. HANDLE UPDATE DARI SUPABASE
function handleTimerUpdate(timerData) {
    debugLog('Processing timer update:', timerData)
    
    if (!timerData) return
    
    // Jangan update jika ini dari admin yang sama (mencegah loop)
    if (isAdmin) {
        debugLog('Admin ignoring own update')
        return
    }
    
    // Update global timer variables (sesuaikan dengan variable di kode Anda)
    const newRemainingTime = timerData.remaining_time
    const newTotalTime = timerData.duration
    const newIsRunning = timerData.is_active
    
    debugLog('Updating local timer:', {
        remaining: newRemainingTime,
        total: newTotalTime,
        running: newIsRunning
    })
    
    // Update tampilan - SESUAIKAN NAMA VARIABLE DENGAN KODE ANDA
    if (typeof remainingTime !== 'undefined') remainingTime = newRemainingTime
    if (typeof totalTime !== 'undefined') totalTime = newTotalTime
    if (typeof isRunning !== 'undefined') isRunning = newIsRunning
    
    // Update tampilan timer - SESUAIKAN NAMA FUNGSI DENGAN KODE ANDA
    if (typeof updateTimerDisplay === 'function') {
        updateTimerDisplay()
    }
    if (typeof updateButtons === 'function') {
        updateButtons()
    }
    
    // Start/stop timer sesuai state
    if (newIsRunning && timerData.started_at) {
        // Hitung waktu yang sudah berlalu
        const startTime = new Date(timerData.started_at).getTime()
        const now = Date.now()
        const elapsed = Math.floor((now - startTime) / 1000)
        const calculatedRemaining = Math.max(0, newTotalTime - elapsed)
        
        debugLog('Calculated remaining time:', calculatedRemaining)
        
        if (typeof remainingTime !== 'undefined') remainingTime = calculatedRemaining
        
        if (calculatedRemaining > 0 && !isRunning) {
            debugLog('Starting local timer')
            // Start timer - SESUAIKAN DENGAN FUNGSI TIMER ANDA
            if (typeof startLocalTimer === 'function') {
                startLocalTimer()
            }
        }
    } else if (!newIsRunning) {
        debugLog('Stopping local timer')
        // Stop timer - SESUAIKAN DENGAN FUNGSI TIMER ANDA
        if (typeof stopLocalTimer === 'function') {
            stopLocalTimer()
        }
    }
}

// 8. MODIFIKASI FUNGSI TIMER EXISTING - TAMBAHKAN SYNC
function startTimer() {
    debugLog('Start timer called')
    
    // Kode start timer existing Anda...
    isRunning = true
    // ... kode lainnya
    
    // TAMBAHKAN INI: Sync ke Supabase
    if (isAdmin) {
        syncTimerToSupabase({
            totalTime: totalTime,
            remainingTime: remainingTime,
            isRunning: true
        })
    }
}

function pauseTimer() {
    debugLog('Pause timer called')
    
    // Kode pause timer existing Anda...
    isRunning = false
    // ... kode lainnya
    
    // TAMBAHKAN INI: Sync ke Supabase
    if (isAdmin) {
        syncTimerToSupabase({
            totalTime: totalTime,
            remainingTime: remainingTime,
            isRunning: false
        })
    }
}

function stopTimer() {
    debugLog('Stop timer called')
    
    // Kode stop timer existing Anda...
    isRunning = false
    remainingTime = totalTime
    // ... kode lainnya
    
    // TAMBAHKAN INI: Sync ke Supabase
    if (isAdmin) {
        syncTimerToSupabase({
            totalTime: totalTime,
            remainingTime: remainingTime,
            isRunning: false
        })
    }
}

// 9. LOAD TIMER STATE TERAKHIR
async function loadInitialTimerState() {
    debugLog('Loading initial timer state...')
    
    try {
        const { data, error } = await supabaseClient
            .from('timer_sessions')
            .select('*')
            .eq('id', currentSessionId)
            .single()
        
        if (error && error.code !== 'PGRST116') {  // PGRST116 = no rows returned
            debugLog('Load state ERROR:', error)
            return
        }
        
        if (data) {
            debugLog('Found existing timer state:', data)
            handleTimerUpdate(data)
        } else {
            debugLog('No existing timer state found')
        }
    } catch (err) {
        debugLog('Load state EXCEPTION:', err)
    }
}

// 10. UPDATE CONNECTION STATUS
function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connection-status')
    if (statusEl) {
        statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`
        statusEl.textContent = connected ? 'Terhubung' : 'Terputus'
    }
    debugLog(`Connection status: ${connected ? 'Connected' : 'Disconnected'}`)
}

// 11. INITIALIZATION
document.addEventListener('DOMContentLoaded', async function() {
    debugLog('DOM Content Loaded - Initializing...')
    
    // Cek admin mode
    const urlParams = new URLSearchParams(window.location.search)
    isAdmin = urlParams.get('admin') === 'true'
    debugLog(`Admin mode: ${isAdmin}`)
    
    // Test connection
    const connectionOK = await testSupabaseConnection()
    if (!connectionOK) {
        alert('Tidak bisa connect ke Supabase! Cek kredensial.')
        return
    }
    
    // Load initial state
    await loadInitialTimerState()
    
    // Subscribe to updates
    subscribeToTimer()
    
    // Add admin indicator
    if (isAdmin) {
        document.body.insertAdjacentHTML('afterbegin', 
            '<div style="position: fixed; top: 10px; left: 10px; background: #4CAF50; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; z-index: 9999;">🔑 ADMIN</div>'
        )
    }
    
    debugLog('Initialization complete')
})

// 12. CLEANUP
window.addEventListener('beforeunload', () => {
    debugLog('Page unloading - cleaning up...')
    if (timerSubscription) {
        timerSubscription.unsubscribe()
    }
})

// 13. TAMBAHKAN HTML UNTUK DEBUG (COPY PASTE KE HTML ANDA)
/*
Tambahkan ini di HTML untuk debugging:

<!-- Connection Status -->
<div id="connection-status" class="connection-status disconnected">
    Connecting...
</div>

<!-- Debug Panel (bisa dihapus setelah jalan) -->
<div id="debug-panel" style="position: fixed; bottom: 10px; left: 10px; width: 300px; height: 200px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 10px; font-size: 12px; overflow: hidden; z-index: 9999;">
    <div style="font-weight: bold; margin-bottom: 10px;">Debug Info:</div>
    <div id="debug-info" style="height: 160px; overflow-y: auto;"></div>
</div>

<!-- CSS untuk status -->
<style>
.connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 8px 15px;
    border-radius: 20px;
    color: white;
    font-size: 14px;
    z-index: 9999;
}
.connected { background: #4CAF50; }
.disconnected { background: #f44336; }
</style>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            position: relative;
        }

        .header {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .section {
            display: none;
            padding: 30px;
        }

        .section.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        input[type="password"], input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .btn {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            margin-top: 10px;
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #dc2626;
            margin: 20px 0;
            padding: 20px;
            background: #fef2f2;
            border-radius: 10px;
            border: 2px solid #fecaca;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .exam-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
            margin: 20px 0;
        }

        .panel-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .bell-animation {
            animation: ring 0.5s ease-in-out;
        }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .google-form-embed {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>


    <div class="container">
        <div class="header">
            <h1>🎓 Sistem Ujian Online</h1>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('student')">Halaman Siswa</button>
                <button class="nav-btn" onclick="showSection('teacher-login')">Panel Guru</button>
            </div>
        </div>

        
        <div id="student" class="section active">
            <div id="exam-waiting" class="exam-info">
                <h2>⏳ Menunggu Ujian Dimulai</h2>
                <p>Silakan tunggu guru memulai ujian. Timer akan muncul ketika ujian sudah dimulai.</p>
                <div id="exam-title" style="font-size: 18px; font-weight: bold; margin-top: 10px; color: #4f46e5;">
                    Belum ada ujian yang diset
                </div>
            </div>

            <div id="exam-active" class="hidden">
                <div class="exam-info">
                    <h2 id="current-exam-title">Nama Ujian</h2>
                    <div class="timer-display" id="timer-display">00:00:00</div>
                    <div class="alert alert-warning" id="time-warning" style="display: none;">
                        ⚠️ Waktu tersisa kurang dari 5 menit!
                    </div>
                </div>

                
                <div id="google-form-container" class="hidden">
                    <h3>📝 Soal Ujian</h3>
                    <iframe id="google-form-frame" class="google-form-embed" src=""></iframe>
                </div>

                <div class="alert alert-danger" id="exam-ended" style="display: none;">
                    ⏰ Waktu ujian telah berakhir! Silakan submit jawaban Anda.
                </div>
            </div>
        </div>

        
        <div id="teacher-login" class="section">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">🔐 Login Guru</h2>
                <div class="form-group">
                    <label for="teacher-password">Password:</label>
                    <input type="password" id="teacher-password" placeholder="Masukkan password guru">
                </div>
                <button class="btn" onclick="loginTeacher()">Masuk</button>
                <div id="login-error" class="alert alert-danger" style="display: none; margin-top: 15px;">
                    Password salah! Silakan coba lagi.
                </div>
            </div>
        </div>

        
        <div id="teacher-panel" class="section">
            <div class="alert alert-success">
                ✅ Selamat datang di Panel Guru!
            </div>

            <div class="panel-controls">
                <div class="control-card">
                    <h3>📋 Setting Ujian</h3>
                    <div class="form-group">
                        <label for="exam-name">Nama Ujian:</label>
                        <input type="text" id="exam-name" placeholder="Contoh: Ujian Matematika Kelas 10">
                    </div>
                    
                    <div class="form-group">
                        <label for="exam-duration">Durasi (menit):</label>
                        <input type="number" id="exam-duration" placeholder="Contoh: 90" min="1" max="300">
                    </div>

                    <div class="form-group">
                        <label for="google-form-url">Link Google Form:</label>
                        <textarea id="google-form-url" rows="3" placeholder="https://docs.google.com/forms/d/e/1FAIpQLSe.../viewform"></textarea>
                        <small style="color: #6b7280;">Pastikan Google Form sudah di-set untuk bisa diakses oleh semua orang</small>
                    </div>

                    <button class="btn" onclick="setExam()">Set Ujian</button>
                </div>

                <div class="control-card">
                    <h3>⏱️ Kontrol Timer</h3>
                    <div class="timer-display" id="teacher-timer">00:00:00</div>
                    
                    <div class="timer-controls">
                        <button class="btn" id="start-btn" onclick="startExam()">▶️ Mulai</button>
                        <button class="btn btn-secondary" onclick="pauseExam()">⏸️ Pause</button>
                        <button class="btn btn-secondary" onclick="stopExam()">⏹️ Stop</button>
                    </div>

                    <div id="timer-status" class="alert alert-warning" style="display: none;">
                        Timer belum diatur
                    </div>
                </div>

                <div class="control-card">
                    <h3>🔧 Kontrol Lainnya</h3>
                    <button class="btn btn-secondary" onclick="ringBell()">🔔 Bunyikan Bell</button>
                    <button class="btn btn-secondary" onclick="resetAll()" style="margin-top: 10px;">🔄 Reset Semua</button>
                    <button class="btn btn-secondary" onclick="logout()" style="margin-top: 10px;">🚪 Logout</button>
                </div>
            </div>
        </div>
    </div>

    
    <audio id="bell-sound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAAS9MYXZmNjAuMTYuMTAwAAAAAAAAAAAAAAAAAP/7kGQAAP8AAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABP/7kGQAAP8AAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABP/7kGQAAP8AAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABP/7kGQAAP8AAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABAAAAAAAAAAA" type="audio/mpeg">
    </audio>

    <script>
        // Konfigurasi
        const TEACHER_PASSWORD = "guru123"; // Ganti dengan password yang diinginkan
        
        // State Management
        let examState = {
            isActive: false,
            isPaused: false,
            duration: 0,
            remainingTime: 0,
            examName: "",
            googleFormUrl: "",
            interval: null
        };

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Teacher Login
        function loginTeacher() {
            const password = document.getElementById('teacher-password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (password === TEACHER_PASSWORD) {
                showSection('teacher-panel');
                document.getElementById('teacher-password').value = '';
                errorDiv.style.display = 'none';
                updateTeacherTimer();
            } else {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Password salah! Silakan coba lagi.';
            }
        }

        // Logout
        function logout() {
            showSection('student');
            document.getElementById('teacher-password').value = '';
        }

        // Set Exam Configuration
        function setExam() {
            const examName = document.getElementById('exam-name').value.trim();
            const duration = parseInt(document.getElementById('exam-duration').value);
            const googleFormUrl = document.getElementById('google-form-url').value.trim();
            
            if (!examName || !duration || duration <= 0) {
                alert('Silakan isi nama ujian dan durasi yang valid!');
                return;
            }
            
            examState.examName = examName;
            examState.duration = duration * 60; // Convert to seconds
            examState.remainingTime = examState.duration;
            examState.googleFormUrl = googleFormUrl;
            
            // Update UI
            document.getElementById('exam-title').textContent = examName;
            document.getElementById('current-exam-title').textContent = examName;
            document.getElementById('timer-status').style.display = 'block';
            document.getElementById('timer-status').textContent = `Ujian "${examName}" telah diset untuk ${duration} menit`;
            document.getElementById('timer-status').className = 'alert alert-success';
            
            updateTimerDisplay();
            updateTeacherTimer();
            
            alert(`Ujian "${examName}" berhasil diset!`);
        }

        // Start Exam
        function startExam() {
            if (examState.duration <= 0) {
                alert('Silakan set ujian terlebih dahulu!');
                return;
            }
            
            examState.isActive = true;
            examState.isPaused = false;
            
            // Show exam interface to students
            document.getElementById('exam-waiting').classList.add('hidden');
            document.getElementById('exam-active').classList.remove('hidden');
            
            // Show Google Form if URL provided
            if (examState.googleFormUrl) {
                document.getElementById('google-form-container').classList.remove('hidden');
                document.getElementById('google-form-frame').src = examState.googleFormUrl;
            }
            
            // Start timer
            startTimer();
            
            // Ring bell to notify students
            ringBell();
            
            // Update UI
            document.getElementById('start-btn').textContent = '▶️ Resume';
        }

        // Pause Exam
        function pauseExam() {
            if (!examState.isActive) return;
            
            examState.isPaused = !examState.isPaused;
            
            if (examState.isPaused) {
                clearInterval(examState.interval);
            } else {
                startTimer();
            }
        }

        // Stop Exam
        function stopExam() {
            examState.isActive = false;
            examState.isPaused = false;
            clearInterval(examState.interval);
            
            // Hide exam interface
            document.getElementById('exam-waiting').classList.remove('hidden');
            document.getElementById('exam-active').classList.add('hidden');
            document.getElementById('google-form-container').classList.add('hidden');
            document.getElementById('exam-ended').style.display = 'block';
            
            // Ring bell to notify end
            ringBell();
            
            // Update UI
            document.getElementById('start-btn').textContent = '▶️ Mulai';
        }

        // Reset All
        function resetAll() {
            if (confirm('Yakin ingin reset semua? Data ujian akan hilang.')) {
                stopExam();
                examState = {
                    isActive: false,
                    isPaused: false,
                    duration: 0,
                    remainingTime: 0,
                    examName: "",
                    googleFormUrl: "",
                    interval: null
                };
                
                // Reset UI
                document.getElementById('exam-name').value = '';
                document.getElementById('exam-duration').value = '';
                document.getElementById('google-form-url').value = '';
                document.getElementById('exam-title').textContent = 'Belum ada ujian yang diset';
                document.getElementById('timer-status').style.display = 'none';
                document.getElementById('exam-ended').style.display = 'none';
                document.getElementById('time-warning').style.display = 'none';
                
                updateTimerDisplay();
                updateTeacherTimer();
            }
        }

        // Timer Functions
        function startTimer() {
            examState.interval = setInterval(() => {
                if (!examState.isPaused && examState.remainingTime > 0) {
                    examState.remainingTime--;
                    updateTimerDisplay();
                    updateTeacherTimer();
                    
                    // Warning when 5 minutes left
                    if (examState.remainingTime === 300) {
                        document.getElementById('time-warning').style.display = 'block';
                        ringBell();
                    }
                    
                    // Time's up
                    if (examState.remainingTime <= 0) {
                        stopExam();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = formatTime(examState.remainingTime);
            document.getElementById('timer-display').textContent = display;
            
            // Change color when time is running low
            const timerDiv = document.getElementById('timer-display');
            if (examState.remainingTime <= 300) { // 5 minutes
                timerDiv.style.color = '#dc2626';
            } else if (examState.remainingTime <= 600) { // 10 minutes
                timerDiv.style.color = '#d97706';
            } else {
                timerDiv.style.color = '#059669';
            }
        }

        function updateTeacherTimer() {
            const display = formatTime(examState.remainingTime);
            document.getElementById('teacher-timer').textContent = display;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Bell Function
        function ringBell() {
            const bell = document.getElementById('bell-sound');
            const container = document.querySelector('.container');
            
            // Visual bell animation
            container.classList.add('bell-animation');
            setTimeout(() => {
                container.classList.remove('bell-animation');
            }, 500);
            
            // Try to play sound (might not work due to browser autoplay policy)
            try {
                bell.currentTime = 0;
                bell.play().catch(e => console.log('Audio autoplay blocked'));
            } catch (e) {
                console.log('Audio not supported');
            }
            
            // Show visual notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4f46e5;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            `;
            notification.textContent = '🔔 BELL!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTimerDisplay();
            updateTeacherTimer();
            
            // Allow Enter key for login
            document.getElementById('teacher-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginTeacher();
                }
            });
        });

        // Prevent page refresh during exam
        window.addEventListener('beforeunload', function(e) {
            if (examState.isActive) {
                e.preventDefault();
                e.returnValue = '';
                return 'Ujian sedang berlangsung. Yakin ingin keluar?';
            }
        });
    </script>


